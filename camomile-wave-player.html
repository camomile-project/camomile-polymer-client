<link rel="import" href="bower_components/polymer/polymer-element.html">
<script src="node_modules/wavesurfer.js/dist/wavesurfer.min.js"></script>
<script src="getElementAt.js"></script>

<dom-module id="camomile-wave-player">

  <template>
    <template is="dom-if" if="{{loading}}">
      <p>Loading waveform {{loadingProgress}}%...</p>
    </template>
    <div id="waveform"></div>
  </template>

  <script>
    class CamomileWavePlayer extends Polymer.Element {
      static get is() {
        return "camomile-wave-player";
      }

      constructor() {
        super();
        this.loading=false;
        this.loaded=false;
      }
      
      _setupMediumView(mediumView) {
        this.wavesurfer.load(mediumView.medium_url);
        this.loading=true;
        this.wavesurfer.on("ready",() => {
          this.loading=false;
          this.loaded=true;
        });
        this.wavesurfer.on("loading",(loadingProgress) => {
          this.loadingProgress=loadingProgress;
        })
      }
      
      _resetMediumView() {
        this.wavesurfer.empty();
        this.loading=false;
        this.loaded=false;
      }

      ready() {
        super.ready();
        this.loading=false;

        this.wavesurfer = WaveSurfer.create({
          container: this.$.waveform,
          xhrWithCredentials: true,
          barHeight:5
        });


        const mediumView = getElementAt(this.srcMediumView);

        if(mediumView.medium) {
          this._setupMediumView(mediumView)
        }
        mediumView.addEventListener("ready", () => this._setupMediumView(mediumView));
        mediumView.addEventListener("reset", () => this._resetMediumView());

        this.beingSought=false;
        this.wavesurfer.on("seek",() => {
          if(this.beingSought)
            return;
          mediumView.currentTime=this.wavesurfer.getCurrentTime();
          mediumView.dispatchEvent(new CustomEvent("timeupdate",{detail:{sender:this.id}}));
        });


        mediumView.addEventListener("timeupdate",({detail:{sender}}) => {
          if (sender === this.id)
            return;
          this.beingSought=true;
          this.wavesurfer.seekAndCenter(mediumView.currentTime/this.wavesurfer.getDuration());
          this.beingSought=false;
        });


        mediumView.addEventListener("rangechanged",({detail:{sender}}) => {
          if (sender === this.id || !this.loaded)
            return;

          this.wavesurfer.zoom(this.$.waveform.clientWidth/(mediumView.range.end-mediumView.range.start));
        });
      }

      static get properties() {
        return {
          srcMediumView: String,
          id: String
        }
      }
    }
    customElements.define(CamomileWavePlayer.is, CamomileWavePlayer);
  </script>

</dom-module>